package presentation.view;

import java.awt.BorderLayout;
import java.awt.CardLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.Toolkit;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPasswordField;
import javax.swing.JTextField;

import constant.role.Role;
import domain.model.users.UsersModel;
import presentation.viewModel.auth.AuthViewModel;
import presentation.viewModel.balance.BalanceViewModel;
import presentation.viewModel.product.ProductViewModel;
import utils.BaseFunc;

public class AuthView extends JFrame {
    private JTextField usernameField;
    private JPasswordField passwordField;
    private JButton loginButton;
    private JButton registerButton;
    private final AuthViewModel authViewModel;
    private  final ProductViewModel productViewModel;
    private final BalanceViewModel balanceViewModel;


    private final JPanel cardPanel;
    private final CardLayout cardLayout;

    private boolean  loginIsVisible = false;
    private boolean registerIsVisible = false;

    public AuthView(AuthViewModel authViewModel, ProductViewModel productViewModel , BalanceViewModel viewModel)  {
        this.authViewModel = authViewModel;
      this.balanceViewModel = viewModel;
        this.productViewModel = productViewModel;
      

        // Set up frame
        setTitle("Authentication");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(600, 400);
        setLayout(new BorderLayout());

        // Center frame and make it visible
        setLocationRelativeTo(null);
        setVisible(true);

        // Initialize card layout for switching between login and register forms
        cardLayout = new CardLayout();
        cardPanel = new JPanel(cardLayout);
        add(cardPanel, BorderLayout.CENTER);

        // Show login form initially
        showLoginForm();
    }

    public void display() {
        showLoginForm();
    }

    private void showLoginForm() {
        JPanel wrapperPanel = new JPanel();
        wrapperPanel.setLayout(new GridLayout(1, 2)); // 1 row, 2 columns for equal sections
        wrapperPanel.setBorder(BorderFactory.createEmptyBorder(0, 0, 0, 0)); // No padding/margin
    
        // Left section
        JPanel leftSection = new JPanel();
        leftSection.setBackground(Color.decode("#238b45"));
        leftSection.setLayout(new BoxLayout(leftSection, BoxLayout.Y_AXIS)); // Vertical layout for logo and text
    
        JLabel logoLabel = new JLabel();
        ImageIcon logoIcon = new ImageIcon("assets/logo.png");
        logoLabel.setIcon(logoIcon);
        logoLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        logoLabel.setMaximumSize(new Dimension(200, 100));
    
        JLabel greenText = new JLabel("Selamat datang di Yoto App!");
        greenText.setFont(new Font("Arial", Font.BOLD, 20));
        greenText.setAlignmentX(Component.CENTER_ALIGNMENT);
        greenText.setForeground(Color.WHITE);
    
        leftSection.add(Box.createVerticalStrut(50));
        leftSection.add(logoLabel);
        leftSection.add(Box.createVerticalStrut(20));
        leftSection.add(greenText);
    
        // Right section
        JPanel rightSection = new JPanel();
        rightSection.setLayout(new BoxLayout(rightSection, BoxLayout.Y_AXIS)); // Column layout for form
        rightSection.setBackground(Color.WHITE);
        rightSection.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20)); // Padding
    
        // Header label
        JLabel headerLabel = new JLabel("Login");
        headerLabel.setFont(new Font("Arial", Font.BOLD, 20));
        headerLabel.setAlignmentX(Component.LEFT_ALIGNMENT); // Align start
        rightSection.add(headerLabel);
        rightSection.add(Box.createVerticalStrut(20)); // Space after label
    
        // Username field
        JLabel usernameLabel = new JLabel("Username:");
        usernameLabel.setAlignmentX(Component.LEFT_ALIGNMENT); // Align start
        JTextField usernameField = new JTextField(20);
        usernameField.setPreferredSize(new Dimension(0, 55)); // Fixed height
        usernameField.setMaximumSize(new Dimension((int)(Toolkit.getDefaultToolkit().getScreenSize().width * 0.7), 55)); // Fixed height and width 70%
        usernameField.setFont(new Font("Arial", Font.PLAIN, 16));
        usernameField.setMargin(new Insets(15, 15, 15, 15)); // Padding inside text field
        rightSection.add(usernameLabel);
        rightSection.add(usernameField);
        rightSection.add(Box.createVerticalStrut(10)); // Space between fields
    
        // Password field
        JLabel passwordLabel = new JLabel("Password:");
        passwordLabel.setAlignmentX(Component.LEFT_ALIGNMENT); // Align start
        JPasswordField passwordField = new JPasswordField(20);
        passwordField.setPreferredSize(new Dimension(0, 55)); // Fixed height
        passwordField.setMaximumSize(new Dimension((int)(Toolkit.getDefaultToolkit().getScreenSize().width * 0.7), 55)); // Fixed height and width 70%
        passwordField.setFont(new Font("Arial", Font.PLAIN, 16));
        passwordField.setMargin(new Insets(15, 15, 15, 15)); // Padding inside text field
        rightSection.add(passwordLabel);
        rightSection.add(passwordField);
        rightSection.add(Box.createVerticalStrut(20)); // Space before buttons
    
        // Button group (Flex layout)
        JPanel buttonPanel = new JPanel();
        buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.X_AXIS)); // Horizontal layout
        buttonPanel.setAlignmentX(Component.LEFT_ALIGNMENT); // Align start
        buttonPanel.setOpaque(false);
    

        loginButton.setFont(new Font("Arial", Font.PLAIN, 16));
        loginButton.setMaximumSize(new Dimension(120, 50));
        loginButton.setAlignmentX(Component.LEFT_ALIGNMENT);
    

        registerButton.setFont(new Font("Arial", Font.PLAIN, 16));
        registerButton.setMaximumSize(new Dimension(120, 50));
        registerButton.setAlignmentX(Component.LEFT_ALIGNMENT);
    
        buttonPanel.add(loginButton);
        buttonPanel.add(Box.createHorizontalStrut(20)); // Space between buttons
        buttonPanel.add(registerButton);
    
        rightSection.add(buttonPanel);
    
        // Add sections to wrapper
        wrapperPanel.add(leftSection);
        wrapperPanel.add(rightSection);
    
        // Add wrapper panel to the card panel
        cardPanel.add(wrapperPanel, "login");
    
        // Add action listeners
        loginButton.addActionListener(e -> handleLogin());
        registerButton.addActionListener(e -> showRegisterForm());
    
        // Show login card
        cardLayout.show(cardPanel, "login");
    }
    
 

    // Helper method to set size for components (like text fields and buttons)

    private void showRegisterForm() {
        JPanel wrapperPanel = new JPanel();
        wrapperPanel.setLayout(new BoxLayout(wrapperPanel, BoxLayout.X_AXIS)); // Flex layout for 50% width sections
        wrapperPanel.setBorder(BorderFactory.createEmptyBorder(0, 0, 0, 0)); // No padding/margin

        // Left section with a green background (fills full height)
        JPanel leftSection = new JPanel();
        leftSection.setBackground(Color.decode("#238b45"));
        leftSection.setPreferredSize(new Dimension(300, this.getHeight())); // Full height

        // Right section with the white background for registration form (fills full
        // height)
        JPanel rightSection = new JPanel();
        rightSection.setLayout(new BoxLayout(rightSection, BoxLayout.Y_AXIS)); // Labels above fields
        rightSection.setBackground(Color.WHITE);
        rightSection.setPreferredSize(new Dimension(300, this.getHeight())); // Full height

        // Add a header for the registration form
        JLabel headerLabel = new JLabel("Register Form");
        headerLabel.setAlignmentX(CENTER_ALIGNMENT);
        headerLabel.setFont(new Font("Arial", Font.BOLD, 20));
        rightSection.add(headerLabel);

        // Form elements for registration
        usernameField = new JTextField(20);
        passwordField = new JPasswordField(20);
        JComboBox<Role> roleComboBox = new JComboBox<>(Role.values());
    
        JButton backToLoginButton = new JButton("Back to Login");

        // Set max height and width for buttons and input fields
        setComponentSize(usernameField, 50, 300);
        setComponentSize(passwordField, 50, 300);
        setComponentSize(registerButton, 50, 300);
        setComponentSize(backToLoginButton, 50, 300);

        // Add labels and fields to the right section (forms)
        rightSection.add(createFieldPanel("Username:", usernameField));
        rightSection.add(createFieldPanel("Password:", passwordField));
        rightSection.add(createFieldPanel("Role:", roleComboBox));
        rightSection.add(Box.createVerticalStrut(20));
        rightSection.add(registerButton);
        rightSection.add(Box.createVerticalStrut(10));
        rightSection.add(backToLoginButton);

        // Add the left (green) and right (white forms) sections to the wrapper panel
        wrapperPanel.add(leftSection);
        wrapperPanel.add(rightSection);

        // Add wrapper panel to the card layout
        cardPanel.add(wrapperPanel, "register");

        // Add action listeners
        registerButton.addActionListener(s -> handleRegister(roleComboBox));
        backToLoginButton.addActionListener(s -> showLoginForm());

        // Display register form
        cardLayout.show(cardPanel, "register");
    }

    private void handleLogin() {
        String username = usernameField.getText();
        String password = new String(passwordField.getPassword());
    
        if (username.isEmpty() || password.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Username and password cannot be empty", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }
    
        authViewModel.login(username, BaseFunc.sha256(password))
        .thenAccept(user -> {
            System.out.println("user: " + user); 
            if (user != null) {
                System.out.println("User ID: " + user.getId());  // log the user ID
                System.out.println("User Role: " + user.getRole());  // log the role
                JOptionPane.showMessageDialog(this, "Login Successful: " + user.getRole());
                if (user.getRole().equals(Role.SELLER)) {
                    System.out.println("Routing to Seller Page with ID: " + user.getId());
                    routeToSellerPage(user.getId() , user.getUsername());
                } else {
                    System.out.println("Routing to Buyer Page with ID: " + user.getId());
                    routeToBuyerPage(user.getUsername());
                }
            } else {
                System.out.println("Invalid credentials or null user returned.");
                JOptionPane.showMessageDialog(this, "Invalid credentials", "Error", JOptionPane.ERROR_MESSAGE);
            }
        }).exceptionally(ex -> {
            System.out.println("Error during login: " + ex.getMessage());
            JOptionPane.showMessageDialog(this, "Error: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
            return null;
        });
    
    }
    

    private void handleRegister(JComboBox<Role> roleComboBox) {
        String username = usernameField.getText();
        String password = new String(passwordField.getPassword());

        if (username.isEmpty() || password.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Username and password cannot be empty", "Error",
                    JOptionPane.ERROR_MESSAGE);
            return;
        }

       String userId = "User-" + (int) (Math.random() * Integer.MAX_VALUE);

        Role selectedRole = (Role) roleComboBox.getSelectedItem();
        UsersModel newUser = new UsersModel(userId, username, BaseFunc.sha256(password), selectedRole);

        authViewModel.register(newUser)
                .thenAccept(isRegistered -> {
                    if (isRegistered) {
                        JOptionPane.showMessageDialog(this, "Registration Successful! Please log in.");
                        showLoginForm();
                        usernameField.setText(""); 
                        passwordField.setText(""); 
                    } else {
                        JOptionPane.showMessageDialog(this, "Registration failed. Try again.", "Error",
                                JOptionPane.ERROR_MESSAGE);
                    }
                }).exceptionally(ex -> {
                    JOptionPane.showMessageDialog(this, "Error: " + ex.getMessage(), "Error",
                            JOptionPane.ERROR_MESSAGE);
                    return null;
                });
    }

    private void routeToSellerPage(String id , String user) {
        JOptionPane.showMessageDialog(this, "Welcome to the Seller Dashboard!");
        this.setVisible(false);
        SellerView sellerView = new SellerView(productViewModel, id , user , balanceViewModel);


        sellerView.setVisible(true);
    }

    private void routeToBuyerPage(String id) {
        JOptionPane.showMessageDialog(this, "Welcome to the Buyer Dashboard!");
        this.setVisible(false);
       UserView userView = new UserView(productViewModel, id , balanceViewModel);
       userView.setVisible(true);
    }

    private JPanel createFieldPanel(String labelText, JComponent inputField) {
        JPanel fieldPanel = new JPanel();
        fieldPanel.setOpaque(false);
        fieldPanel.setLayout(new BoxLayout(fieldPanel, BoxLayout.Y_AXIS)); // Stack the label and input vertically
        JLabel label = new JLabel(labelText);
        label.setFont(new Font("Arial", Font.PLAIN, 16));
        label.setOpaque(false);
        label.setAlignmentX(Component.LEFT_ALIGNMENT);

        fieldPanel.add(label); // Add the label
        fieldPanel.add(inputField); // Add the input field
        return fieldPanel;
    }

    private void setComponentSize(JComponent component, int height, int width) {
        component.setMaximumSize(new Dimension(width, height));
        component.setPreferredSize(new Dimension(width, height));
    }

}
